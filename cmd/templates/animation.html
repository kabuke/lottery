<style>
    #slot-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.95);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 1000; opacity: 0; transition: opacity 0.3s;
    }
    #slot-machine {
        width: 90%; max-width: 600px; height: 150px;
        background: #111; border: 5px solid #555; border-radius: 10px;
        display: flex; justify-content: space-around;
        overflow: hidden; position: relative;
    }
    .reel {
        width: 33%;
        text-align: center;
    }
    .reel-item {
        font-size: 2.5rem; font-weight: bold; color: white;
        height: 150px; line-height: 150px;
        text-shadow: 0 0 5px #fff;
    }
    #winner-line {
        position: absolute; top: 50%; left: 0; right: 0; margin-top: -2px;
        height: 4px; background-color: #e44; z-index: 3;
        box-shadow: 0 0 10px #ff7b7b;
    }
    #confirm-winner-btn {
        display: none;
        margin-top: 20px;
        padding: 10px 30px;
        font-size: 1.2rem;
    }
</style>

<div id="slot-modal">
    <div id="slot-machine">
        <div id="winner-line"></div>
        <div class="reel" id="reel1"></div>
        <div class="reel" id="reel2"></div>
        <div class="reel" id="reel3"></div>
    </div>
    <button id="confirm-winner-btn">確定</button>
</div>

<script>
(function() {
    const modal = document.getElementById('slot-modal');
    const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
    const confirmBtn = document.getElementById('confirm-winner-btn');
    
    const initialSpinTime = 2000; // Initial spin before first stop
    const stopInterval = 800;     // Time between each reel stopping

    const participants = [
        {{range $i, $p := .EligibleParticipants}}
            "{{$p.Name}}",
        {{end}}
    ];
    const winnerName = "{{.Winner.WinnerName}}";

    // --- Sounds ---
    const spinSound = new Audio('/assets/SlotMachine_Wheel.mp3');
    const winSound = new Audio('/assets/you-win-sequence-2.mp3');
    spinSound.onerror = () => console.log("Could not load spin sound.");
    winSound.onerror = () => console.log("Could not load win sound.");

    // --- Character Distribution Logic ---
    function getWinnerChars(name) {
        const chars = Array.from(name);
        const len = chars.length;
        if (len === 0) return [" ", " ", " "];

        const baseSize = Math.floor(len / 3);
        const remainder = len % 3;

        let p1_end = baseSize + (remainder > 0 ? 1 : 0);
        let p2_end = p1_end + baseSize + (remainder > 1 ? 1 : 0);

        const part1 = chars.slice(0, p1_end).join('');
        const part2 = chars.slice(p1_end, p2_end).join('');
        const part3 = chars.slice(p2_end).join('');

        return [part1, part2, part3];
    }

    const winnerChars = getWinnerChars(winnerName);
    const charPool = Array.from(participants.join('\n'));

    // --- Setup Reels ---
    reels.forEach((reel, reelIndex) => {
        const pool = [...charPool].sort(() => 0.5 - Math.random());
        const winnerChar = winnerChars[reelIndex];
        
        if (pool.indexOf(winnerChar) === -1) pool.push(winnerChar);

        const repeated = Array(30).fill(pool).flat();
        const winnerPos = repeated.lastIndexOf(winnerChar);
        
        reel.innerHTML = repeated.map(p => `<div class="reel-item">${p}</div>`).join('');
        reel.dataset.winnerPos = winnerPos;
    });

    // --- Event Listener ---
    confirmBtn.addEventListener('click', () => {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.remove();
            htmx.trigger("body", "updateLotteryPage", {});
        }, 300);
    });

    // --- Animation Logic ---
    function startAnimation() {
        modal.style.opacity = '1';
        spinSound.loop = true;
        spinSound.play().catch(e => console.log("Spin sound playback failed."));

        // 1. Start all reels spinning indefinitely
        reels.forEach(reel => {
            reel.style.transition = `transform 10s linear`;
            reel.style.transform = `translateY(-${(reel.children.length - 5) * 150}px)`;
        });

        // 2. Trigger the first stop
        setTimeout(() => stopReel(0), initialSpinTime);
    }

    function stopReel(reelIndex) {
        const reel = reels[reelIndex];
        const winnerPos = reel.dataset.winnerPos;
        const finalPosition = winnerPos * 150;
        
        // Set a sharp, final transition to the winning character
        reel.style.transition = `transform 0.8s cubic-bezier(0.25, 1, 0.5, 1)`;
        reel.style.transform = `translateY(-${finalPosition}px)`;

        // If there is a next reel, schedule its stop. Otherwise, show the result.
        if (reelIndex < reels.length - 1) {
            setTimeout(() => stopReel(reelIndex + 1), stopInterval);
        } else {
            setTimeout(showResult, 800); // Wait for the last reel to settle
        }
    }

    function showResult() {
        spinSound.pause();
        winSound.play().catch(e => console.log("Win sound playback failed."));

        reels.forEach((reel, index) => {
            const winnerElement = reel.children[reel.dataset.winnerPos];
            if(winnerElement) {
                winnerElement.style.color = '#ffdd00';
                winnerElement.style.transform = 'scale(1.1)';
            }
        });

        confirmBtn.style.display = 'block';
    }

    startAnimation();
})();
</script>